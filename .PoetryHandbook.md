# Poetry Handbook â€” CoupaDownloads

Quick cheatsheet for managing this workspace with Poetry (Python 3.12.x).

Basics
- Select Python: `poetry env use 3.12`
- Install (core + ML group): `poetry install --with ml`
- Run a command: `poetry run python -m module.path` or `poetry run pytest -q`
- Shell inside venv: `poetry shell` (exit with `exit`)

Environment
- Show env info: `poetry env info`
- List envs: `poetry env list`
- Remove current env: `poetry env remove python`

Dependencies
- Add runtime dep: `poetry add requests@^2.32`
- Add to a group: `poetry add --group ml sentence-transformers`
- Add dev dep: `poetry add --group dev pytest`
- Remove dep: `poetry remove package-name`
- Update deps: `poetry update`

Exporting for CI/pip
- Export all (incl. groups): `poetry export -f requirements.txt -o requirements.lock.txt --with ml --without-hashes`
- Only core: `poetry export -f requirements.txt -o requirements.core.lock.txt --without-hashes`

Lockfile
- Recreate lock: `rm poetry.lock && poetry lock`
- Check constraints: `poetry check`

Scripts (defined in pyproject)
- List scripts: check `[tool.poetry.scripts]` in `pyproject.toml`
- Run script: `poetry run coupa-downloader`

Common flows
- Project bootstrap (this repo):
  - `poetry env use 3.12`
  - `poetry install --with ml`
  - `poetry run pip install -r embeddinggemma_feasibility/requirements.txt`
- RAG build/query:
  - `poetry run python -m embeddinggemma_feasibility.rag.cli build --source embeddinggemma_feasibility/data/sample_documents --persist embeddinggemma_feasibility/data/rag_index`
  - `poetry run python -m embeddinggemma_feasibility.rag.cli query --index embeddinggemma_feasibility/data/rag_index --q "termos de entrega" --top-k 8 --return-k 3 --reranker`
- Interactive menu (RAG + advanced extractor):
  - `poetry run python -m embeddinggemma_feasibility.interactive_cli`

Tips
- In-project venv: configured via `poetry.toml` (`virtualenvs.in-project = true`)
- macOS: if you use zsh + pyenv, ensure shims precede system Python in PATH.
- Torch/Transformers on Apple Silicon: if wheels fail, pin a compatible version and set `export PYTORCH_ENABLE_MPS_FALLBACK=1` when needed.
- Playwright: one-time `poetry run playwright install` for browsers.

Troubleshooting
- Mixed Python versions: check `.python-version` and `poetry env use 3.12`.
- SSL/cert issues: try `pip install --trusted-host` as a workaround inside `poetry run`.
- Cache cleanup: `poetry cache clear pypi --all`
